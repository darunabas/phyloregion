---
title: "Benchmark"
author: "Barnabas H. Daru, Piyal Karunarathne & Klaus Schliep"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: rmarkdown::html_vignette
bibliography: phyloregion.bib
vignette: >
   %\VignetteIndexEntry{phylorregion-intro}
   %\VignetteEngine{knitr::rmarkdown}
   %\usepackage[utf8]{inputenc}
---

## Benchmarking `phyloregion`

In this vignette, we benchmark `phyloregion` against other similar `R` 
packages in analyses of compositional turnover (beta diversity and 
phylogenetic beta diversity) and more standard conservation measures 
of alpha diversity such as phylogenetic diversity. Specifically, we 
compared `phyloregion`'s functions with available packages for memory 
efficiency and computation speed for various biogeographic analyses.

First, load the packages for the benchmarking:

```{r, message=FALSE, results='hide', warning=FALSE}
library(ape)
library(Matrix)
library(bench)
library(ggplot2)
# the packages for benchmarking
library(phyloregion)
library(betapart)
library(picante)
library(vegan)
library(hilldiv)
library(BAT) # Not working
library(PDcalc)
```
We will use a small data set which comes with `phyloregion`.

```{r, message=FALSE, warning=FALSE}
data(africa)
tree <- africa$phylo
# subset matrix
X_sparse <- africa$comm[1:30, ]
X_sparse <- X_sparse[, colSums(X_sparse)>0]
X_dense <- as.matrix(X_sparse)
Xt_dense <- t(X_dense)

object.size(X_sparse)
```

```
## 76504 bytes
```

```r
object.size(X_dense)
```

```
## 134752 bytes
```

```r
dim(X_sparse)
```

```
## [1]  30 401
```
To make results comparable, it is sometimes desirable to make sure 
that the taxa in different datasets match each other. For example, 
the community matrix in the `hilldiv` package needs to be transposed.
These transformations can influence the execution times, often only marginally.
To benchmark, we used the package `bench` because it returns execution times
and provides some estimate on memory allocations for each computation.

## 1. Analysis of compositional turnover (beta diversity)
#### 1.1. Benchmarking `phyloregion` for analysis of taxonomic beta diversity

For analysis of taxonomic beta diversity, `phyloregion` has marginal advantage 
over other packages:

```r
chk_fun <- function(target, current)
    all.equal(target, current, check.attributes = FALSE)

fun_phyloregion <- function(x) as.matrix(phyloregion::beta_diss(x)[[3]])
fun_betapart <- function(x) as.matrix(betapart::beta.pair(x)[[3]])
fun_vegan  <- function(x) as.matrix(vegan::vegdist(x, binary=TRUE))
fun_BAT <- function(x) as.matrix(BAT::beta(x, func = "Soerensen")[[1]])

results1 <- bench::mark(phyloregion=fun_phyloregion(X_sparse), betapart=fun_betapart(X_dense),
                       vegan=fun_vegan(X_dense), BAT=fun_BAT(X_dense), check=chk_fun)
summary(results1)
```

```
## # A tibble: 4 x 6
##   expression                     min   median `itr/sec` mem_alloc `gc/sec`
##   <bch:expr>                <bch:tm> <bch:tm>     <dbl> <bch:byt>    <dbl>
## 1 fun_phyloregion(X_sparse)  948.2µs   1.09ms     817.    286.7KB     0   
## 2 fun_betapart(X_dense)      985.8µs   1.17ms     578.    575.4KB     0   
## 3 fun_vegan(X_dense)         865.1µs   1.09ms     785.    893.2KB     2.10
## 4 fun_BAT(X_dense)            44.9ms  47.08ms      21.3    31.7MB     2.13
```

```{r fig.align="left", echo=TRUE, fig.width=12,fig.height=6,fig.cap="Benchmarking phyloregion against other packages in analysis of species compositional turnover (beta diversity).", out.width = '50%', fig.pos="h"}
autoplot(results1)
```

![plot of chunk beta_diversity](figure/beta_diversity-1.png)

#### 1.2. Benchmarking `phyloregion` for analysis of phylogenetic beta diversity
For analysis phylogenetic turnover (beta-diversity) among communities - the 
proportion of shared phylogenetic branch lengths between communities - 
`phyloregion` is 3-7 times faster and 100-600 times efficient in 
memory allocation!

```r
fun_phyloregion <- function(x, tree) phyloregion::phylobeta(x, tree)[[3]]
fun_betapart <- function(x, tree) betapart::phylo.beta.pair(x, tree)[[3]]
fun_picante <- function(x, tree) 1 - picante::phylosor(x, tree)
fun_BAT <- function(x, tree) BAT::beta(x, tree, func = "Soerensen")[[1]]

chk_fun <- function(target, current)
    all.equal(target, current, check.attributes = FALSE)

results2 <- bench::mark(picante=fun_picante(X_dense, tree),
                       betapart=fun_betapart(X_dense, tree),
                       BAT=fun_BAT(X_dense, tree),
                       phyloregion=fun_phyloregion(X_sparse, tree), check=chk_fun)
```

```
## Warning: Some expressions had a GC in every iteration; so filtering is disabled.
```

```r
summary(results2)
```

```
## Warning: Some expressions had a GC in every iteration; so filtering is disabled.
```

```
## # A tibble: 4 x 6
##   expression                           min   median `itr/sec` mem_alloc `gc/sec`
##   <bch:expr>                      <bch:tm> <bch:tm>     <dbl> <bch:byt>    <dbl>
## 1 fun_picante(X_dense, tree)          2.5s     2.5s     0.400    1.24GB     2.00
## 2 fun_betapart(X_dense, tree)        2.54s    2.54s     0.394    1.24GB     1.97
## 3 fun_BAT(X_dense, tree)             1.28s    1.28s     0.779  207.32MB     0   
## 4 fun_phyloregion(X_sparse, tree)   4.89ms   5.18ms   169.    1023.17KB     1.99
```
```{r fig.align="left", echo=TRUE, fig.width=12,fig.height=6,fig.cap="Benchmarking phyloregion against other packages in analysis of phylogenetic turnover (phylogenetic beta diversity).", out.width = '50%', fig.pos="h"}
autoplot(results2)
```
![plot of chunk phylobeta](figure/phylobeta-1.png)
Note that for this test, `picante` returns a similarity matrix while
`betapart` and `phyloregion` return a dissimilarity matrix.


## 2. Analysis of alpha diversity
#### 2.1. Benchmarking `phyloregion` for analysis of phylogenetic diversity
For analysis of more standard conservation measures such as phylogenetic 
diversity - the sum of all phylogenetic branch lengths within an area 
(Faith 1992) - phyloregion is 34 to 99 orders of magnitude memory efficient!

```r
tree <- africa$phylo
tree <- keep.tip(tree, colnames(X_sparse))

pd_picante <- function(x, tree){
    res <- picante::pd(x, tree)[,1]
    names(res) <- row.names(x)
    res
}

pd_PDcalc <- function(x, tree){
    res <- PDcalc::phylodiv(x, tree)[,1]
    names(res) <- row.names(x)
    res
}
pd_hilldiv <- function(x, tree) hilldiv::index_div(x, tree, index="faith")
pd_phyloregion <- function(x, tree) phyloregion::PD(x, tree)

results3 <- bench::mark(pd_picante(X_dense, tree),
          pd_PDcalc(X_dense, tree),
          pd_hilldiv(Xt_dense,tree=tree),
          pd_phyloregion(X_sparse, tree))
```

```
## Warning: Some expressions had a GC in every iteration; so filtering is disabled.
```

```r
summary(results3)
```

```
## Warning: Some expressions had a GC in every iteration; so filtering is disabled.
```

```
## # A tibble: 3 x 6
##   expression                             min   median `itr/sec` mem_alloc `gc/sec`
##   <bch:expr>                        <bch:tm> <bch:tm>     <dbl> <bch:byt>    <dbl>
## 1 pd_picante(X_dense, tree)         116.16ms 121.45ms     7.55     59.4MB    1.89 
## 2 pd_hilldiv(Xt_dense, tree = tree)    1.08s    1.08s     0.926   170.1MB    0.926
## 3 pd_phyloregion(X_sparse, tree)      3.12ms   3.44ms   276.      883.9KB    0
```

```r
autoplot(results3)
```

![plot of chunk phylo_diversity](figure/phylo_diversity-1.png)

#### 2.2. Benchmarking `phyloregion` for analysis of phylogenetic endemism
Another test for phyloregion is in analysis of phylogenetic endemism, the 
degree to which phylogenetic diversity is restricted to any given area 
(Rosauer et al. 2009). Here, we found that `phyloregion`

For analysis of more standard conservation measures such as phylogenetic 
diversity - the sum of all phylogenetic branch lengths within an area 
(Faith 1992) - phyloregion is 34 to 99 orders of magnitude memory efficient!

```r
tree <- africa$phylo
tree <- keep.tip(tree, colnames(X_sparse))

pe_PDcalc <- function(x, tree){
    res <- PDcalc::phyloendemism(x, tree)[,1]
    names(res) <- row.names(x)
    res
}
pe_phyloregion <- function(x, tree) phyloregion::phylo_endemism(x, tree)

chk_fun <- function(target, current)
    all.equal(target, current, check.attributes = FALSE)
    
results4 <- bench::mark(PDcalc=pe_PDcalc(X_dense, tree),
          phyloregion=pe_phyloregion(X_sparse, tree), check=chk_fun)
```

```
## Warning: Some expressions had a GC in every iteration; so filtering is disabled.
```

```r
summary(results3)
```

```
## Warning: Some expressions had a GC in every iteration; so filtering is disabled.
```

```
## # A tibble: 3 x 6
##   expression                             min   median `itr/sec` mem_alloc `gc/sec`
##   <bch:expr>                        <bch:tm> <bch:tm>     <dbl> <bch:byt>    <dbl>
## 1 pd_picante(X_dense, tree)         116.16ms 121.45ms     7.55     59.4MB    1.89 
## 2 pd_hilldiv(Xt_dense, tree = tree)    1.08s    1.08s     0.926   170.1MB    0.926
## 3 pd_phyloregion(X_sparse, tree)      3.12ms   3.44ms   276.      883.9KB    0
```

```r
autoplot(results3)
```

![plot of chunk phylo_diversity](figure/phylo_diversity-1.png)

## Session Infomation

```r
sessionInfo()
```

```
## R version 3.6.2 (2019-12-12)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Debian GNU/Linux 10 (buster)
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/openblas/libblas.so.3
## LAPACK: /usr/lib/x86_64-linux-gnu/libopenblasp-r0.3.5.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C               LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8    LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C             LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] pkgdown_1.4.1.9000 BAT_2.0.0          hilldiv_1.5.1      picante_1.8.1      nlme_3.1-144      
##  [6] vegan_2.5-6        lattice_0.20-38    permute_0.9-5      betapart_1.5.1     ggplot2_3.2.1     
## [11] bench_1.1.1.9000   ape_5.3            knitr_1.28         raster_3.0-12      data.table_1.12.8 
## [16] phyloregion_0.1.0  Matrix_1.2-18      sp_1.3-2          
## 
## loaded via a namespace (and not attached):
##   [1] backports_1.1.5         Hmisc_4.3-1             BDgraph_2.62            fastmatch_1.1-0        
##   [5] plyr_1.8.5              igraph_1.2.4.2          lazyeval_0.2.2          splines_3.6.2          
##   [9] crosstalk_1.0.0         digest_0.6.24           htmltools_0.4.0         fansi_0.4.1            
##  [13] memoise_1.1.0           magrittr_1.5            checkmate_2.0.0         tensor_1.5             
##  [17] cluster_2.1.0           ks_1.11.7               fastcluster_1.1.25      pdist_1.2              
##  [21] prettyunits_1.1.1       jpeg_0.1-8.1            colorspace_1.4-1        xfun_0.12              
##  [25] dplyr_0.8.4             callr_3.4.2             crayon_1.3.4            jsonlite_1.6.1         
##  [29] spatstat_1.63-0         spatstat.data_1.4-3     survival_3.1-8          phangorn_2.6.0         
##  [33] glue_1.3.1              polyclip_1.10-0         gtable_0.3.0            geiger_2.0.6.4         
##  [37] webshot_0.5.2           ggm_2.5                 maps_3.3.0              abind_1.4-5            
##  [41] scales_1.1.0            mvtnorm_1.0-12          miniUI_0.1.1.1          Rcpp_1.0.3             
##  [45] xtable_1.8-4            progress_1.2.2          htmlTable_1.13.3        magic_1.5-9            
##  [49] foreign_0.8-72          subplex_1.5-4           mclust_5.4.5            deSolve_1.27.1         
##  [53] Formula_1.2-3           stats4_3.6.2            httr_1.4.1              htmlwidgets_1.5.1      
##  [57] RColorBrewer_1.1-2      lavaan_0.6-5            acepack_1.4.1           farver_2.0.3           
##  [61] pkgconfig_2.0.3         deldir_0.1-25           nnet_7.3-12             utf8_1.1.4             
##  [65] tidyselect_1.0.0        rlang_0.4.4             manipulateWidget_0.10.0 reshape2_1.4.3         
##  [69] later_1.0.0             munsell_0.5.0           tools_3.6.2             cli_2.0.1              
##  [73] fdrtool_1.2.15          evaluate_0.14           geometry_0.4.5          stringr_1.4.0          
##  [77] fastmap_1.0.1           yaml_2.2.1              goftest_1.2-2           rematch2_2.1.0         
##  [81] processx_3.4.2          fs_1.3.1                rgl_0.100.47            purrr_0.3.3            
##  [85] packrat_0.5.0           glasso_1.11             pbapply_1.4-2           whisker_0.4            
##  [89] mime_0.9                profmem_0.5.0           compiler_3.6.2          rstudioapi_0.11        
##  [93] curl_4.3                beeswarm_0.2.3          png_0.1-7               e1071_1.7-3            
##  [97] ggsignif_0.6.0          spatstat.utils_1.17-0   huge_1.3.4              tibble_2.1.3           
## [101] pbivnorm_0.6.0          stringi_1.4.6           ps_1.3.2                highr_0.8              
## [105] desc_1.2.0              qgraph_1.6.4            rgeos_0.5-2             psych_1.9.12.31        
## [109] vctrs_0.2.3             pillar_1.4.3            lifecycle_0.1.0         corpcor_1.6.9          
## [113] httpuv_1.5.2            R6_2.4.1                latticeExtra_0.6-29     promises_1.1.0         
## [117] KernSmooth_2.23-16      gridExtra_2.3           vipor_0.4.5             codetools_0.2-16       
## [121] rcdd_1.2-2              MASS_7.3-51.4           gtools_3.8.1            assertthat_0.2.1       
## [125] rprojroot_1.3-2         rjson_0.2.20            withr_2.1.2             mnormt_1.5-6           
## [129] mgcv_1.8-31             parallel_3.6.2          hms_0.5.3               quadprog_1.5-8         
## [133] grid_3.6.2              rpart_4.1-15            tidyr_1.0.2             coda_0.19-3            
## [137] class_7.3-15            rmarkdown_2.1           nls2_0.2                FSA_0.8.27             
## [141] hypervolume_2.0.12      d3Network_0.5.2.1       ggpubr_0.2.5            shiny_1.4.0            
## [145] base64enc_0.1-3         ggbeeswarm_0.6.0
```

